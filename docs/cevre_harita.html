<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒ∞stanbul √áevre Haritasƒ± - AI √ñnerileri</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      header {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      h1 {
        color: #667eea;
        font-size: 2em;
        margin-bottom: 10px;
      }

      .controls {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .legend {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: center;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .color-box {
        width: 30px;
        height: 30px;
        border-radius: 5px;
        border: 2px solid #333;
      }

      #map {
        height: 700px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .leaflet-popup-content {
        font-family: "Segoe UI", sans-serif;
        min-width: 300px;
      }

      .popup-title {
        font-size: 1.3em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
      }

      .popup-stats {
        background: #f5f7fa;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .popup-stat {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
      }

      .popup-score {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        display: inline-block;
        margin-top: 10px;
      }

      .popup-project {
        background: #d1ecf1;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        border-left: 4px solid #667eea;
      }

      .popup-project-title {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }

      .back-button {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        text-decoration: none;
        margin-top: 10px;
        transition: all 0.3s;
      }

      .back-button:hover {
        background: #764ba2;
        transform: translateY(-2px);
      }

      .loading {
        text-align: center;
        color: #667eea;
        font-size: 1.2em;
        padding: 20px;
      }

      .data-badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85em;
        margin-left: 10px;
        font-weight: bold;
      }

      .ilce-label {
        background: rgba(255, 255, 255, 0.9) !important;
        border: 1px solid #667eea !important;
        border-radius: 5px !important;
        padding: 2px 6px !important;
        font-size: 0.75em !important;
        font-weight: bold !important;
        color: #333 !important;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üå≥ ƒ∞stanbul √áevre Haritasƒ± - Park & Ye≈üil Alan Analizi</h1>
        <p style="color: #666; margin-top: 10px">
          ƒ∞l√ßeleri tƒ±klayarak park ve ye≈üil alan detaylarƒ±nƒ± g√∂r√ºn
          <span id="data-badge" class="data-badge">Y√ºkleniyor...</span>
        </p>
        <a href="/cevre" class="back-button">‚Üê √áevre Analizi</a>
      </header>

      <div class="controls">
        <div class="legend">
          <strong style="margin-right: 10px">Ye≈üil Alan Eksikliƒüi:</strong>
          <div class="legend-item">
            <div class="color-box" style="background: #2ecc71"></div>
            <span>Az (0-40)</span>
          </div>
          <div class="legend-item">
            <div class="color-box" style="background: #f39c12"></div>
            <span>Orta (40-70)</span>
          </div>
          <div class="legend-item">
            <div class="color-box" style="background: #e74c3c"></div>
            <span>Y√ºksek (70-100)</span>
          </div>
        </div>
        <div id="status" class="loading">Harita y√ºkleniyor...</div>
      </div>

      <div id="map"></div>
    </div>

    <script>
      // Harita ba≈ülat
      const map = L.map("map").setView([41.0082, 28.9784], 10);

      // Tile layer
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);

      // ƒ∞stanbul il√ße koordinatlarƒ± (39 ƒ∞L√áE)
      const ilceKoordinatlari = {
        Esenyurt: [41.0318, 28.6767],
        Beylikd√ºz√º: [41.0045, 28.645],
        Sultangazi: [41.1061, 28.8756],
        B√ºy√ºk√ßekmece: [41.0217, 28.5856],
        Silivri: [41.0752, 28.2467],
        √áatalca: [41.1444, 28.4611],
        Adalar: [40.8786, 29.1194],
        Arnavutk√∂y: [41.1856, 28.7428],
        Ata≈üehir: [40.9827, 29.1244],
        Avcƒ±lar: [40.9789, 28.7214],
        Baƒücƒ±lar: [41.0392, 28.8567],
        Bah√ßelievler: [40.9989, 28.8553],
        Bakƒ±rk√∂y: [40.9789, 28.8739],
        Ba≈üak≈üehir: [41.0906, 28.805],
        Bayrampa≈üa: [41.0458, 28.9097],
        Be≈üikta≈ü: [41.0422, 29.0072],
        Beykoz: [41.1289, 29.095],
        Beyoƒülu: [41.0392, 28.9778],
        √áekmek√∂y: [41.0319, 29.1833],
        Esenler: [41.0403, 28.8814],
        Ey√ºpsultan: [41.0578, 28.9203],
        Fatih: [41.0186, 28.9494],
        Gaziosmanpa≈üa: [41.0744, 28.9111],
        G√ºng√∂ren: [41.0167, 28.8753],
        Kadƒ±k√∂y: [40.9833, 29.0333],
        Kaƒüƒ±thane: [41.0778, 28.9764],
        Kartal: [40.9, 29.1833],
        K√º√ß√ºk√ßekmece: [41.0083, 28.7817],
        Maltepe: [40.9367, 29.1417],
        Pendik: [40.8786, 29.2333],
        Sancaktepe: [40.9906, 29.2306],
        Sarƒ±yer: [41.1667, 29.05],
        Sultanbeyli: [40.9667, 29.2667],
        ≈ûile: [41.1744, 29.6089],
        ≈ûi≈üli: [41.0608, 28.9875],
        Tuzla: [40.8247, 29.2972],
        √úmraniye: [41.0167, 29.1167],
        √úsk√ºdar: [41.0253, 29.0156],
        Zeytinburnu: [40.9894, 28.9008],
      };

      // Renk belirleme (eksiklik skoruna g√∂re)
      function getColor(score) {
        if (score >= 70) return "#e74c3c"; // Y√ºksek eksiklik
        if (score >= 40) return "#f39c12"; // Orta eksiklik
        return "#2ecc71"; // Az eksiklik
      }

      // √áevre verilerini y√ºkle
      async function loadCevreData() {
        try {
          document.getElementById("status").textContent =
            "Veriler API'den y√ºkleniyor...";

          const analizRes = await fetch("/api/cevre/analiz-verisi");
          const analizData = await analizRes.json();

          const onerilerRes = await fetch("/api/cevre/yatirim-onerileri");
          const onerilerData = await onerilerRes.json();

          console.log("√áevre Analiz data:", analizData);
          console.log("√áevre √ñneriler data:", onerilerData);

          // ƒ∞l√ße sayƒ±sƒ± badge'i g√ºncelle
          const ilceSayisi = analizData.en_sorunlu_ilceler.length;
          const dataBadge = document.getElementById("data-badge");
          if (ilceSayisi === 39) {
            dataBadge.textContent = "‚úÖ 39 ƒ∞l√ße Tam Veri";
            dataBadge.style.background = "#667eea";
          } else {
            dataBadge.textContent = `‚ö†Ô∏è ${ilceSayisi} ƒ∞l√ße`;
            dataBadge.style.background = "#ffa500";
          }

          document.getElementById(
            "status"
          ).textContent = `‚úÖ ${ilceSayisi} il√ße y√ºklendi`;

          // Her il√ße i√ßin haritaya ekle
          analizData.en_sorunlu_ilceler.forEach((ilce) => {
            console.log(`ƒ∞≈üleniyor: ${ilce.ilce}`);

            // Koordinat bul
            const coords = ilceKoordinatlari[ilce.ilce];
            if (!coords) {
              console.warn(`${ilce.ilce} koordinatlarƒ± bulunamadƒ±!`);
              return;
            }

            // √ñnerileri bul
            const ilceOneri = onerilerData.find((o) => o.ilce === ilce.ilce);

            const color = getColor(ilce.genel_cevre_skoru);
            const radius = Math.max(
              10,
              Math.min(30, Math.sqrt(ilce.nufus) / 50)
            );

            const marker = L.circleMarker(coords, {
              radius: radius,
              fillColor: color,
              color: "#333",
              weight: 2,
              opacity: 1,
              fillOpacity: 0.7,
            }).addTo(map);

            // Popup i√ßeriƒüi
            const popupContent = `
              <div class="popup-title">${ilce.ilce}</div>
              
              <div class="popup-stats">
                <div class="popup-stat">
                  <span>üë• N√ºfus:</span>
                  <strong>${(ilce.nufus / 1000).toFixed(0)}K</strong>
                </div>
                <div class="popup-stat">
                  <span>üèûÔ∏è Park Sayƒ±sƒ±:</span>
                  <strong>${ilce.park_sayisi || 0}</strong>
                </div>
                <div class="popup-stat">
                  <span>üå≥ Ye≈üil Alan:</span>
                  <strong>${(ilce.yesil_alan_hektar || 0).toFixed(
                    1
                  )} ha</strong>
                </div>
                <div class="popup-stat">
                  <span>üìè m¬≤/Ki≈üi:</span>
                  <strong>${(ilce.kisi_basina_yesil_m2 || 0).toFixed(
                    1
                  )}</strong>
                </div>
              </div>
              
              <div class="popup-score">
                üìä Eksiklik Skoru: ${(ilce.genel_cevre_skoru || 0).toFixed(
                  1
                )}/100
              </div>

              ${
                ilceOneri && ilceOneri.proje_adi
                  ? `
              <div class="popup-project">
                <div class="popup-project-title">üå± AI √ñnerisi: ${
                  ilceOneri.proje_adi
                }</div>
                <p style="font-size: 0.9em; color: #0c5460;">
                  ${(ilceOneri.proje_detay || "").substring(0, 150)}...
                </p>
                ${
                  ilceOneri.tahmini_maliyet
                    ? `<div style="margin-top: 5px; font-weight: bold; color: #0c5460;">
                      üí∞ ${ilceOneri.tahmini_maliyet}
                    </div>`
                    : ""
                }
              </div>
              `
                  : ""
              }
            `;

            marker.bindPopup(popupContent, { maxWidth: 400 });

            // ƒ∞l√ße adƒ±nƒ± noktanƒ±n altƒ±na tooltip olarak ekle (ula≈üƒ±m sayfasƒ± ile uyumlu)
            marker.bindTooltip(ilce.ilce, {
              permanent: true,
              direction: "bottom",
              className: "ilce-label",
              opacity: 0.95,
              offset: [0, 15],
            });
          });
        } catch (err) {
          console.error("Veri y√ºkleme hatasƒ±:", err);
          document.getElementById("status").innerHTML =
            "‚ùå Veriler y√ºklenemedi: " + err.message;
        }
      }

      // Sayfa y√ºklendiƒüinde veri √ßek
      window.addEventListener("load", () => {
        loadCevreData();
      });
    </script>
  </body>
</html>
